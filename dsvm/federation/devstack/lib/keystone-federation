# Library to support Keystone federation on devstack

# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# lib/keystone-federation
# Functions to control the installation, configuration and operation of
# **Keystone** federation

# Dependencies:
#
# - ``functions`` file
#
# lib/keystone-federation exports the following functions:
#
# - install_keystone_federation
# - configure_keystone_federation
# - init_keystone_federation
# - start_keystone_federation
# - stop_keystone_federation


function _install_mod_shib {
    # TODO(dstanek): maybe we should make sure that Apache support was
    # enabled for Keystone
    if is_ubuntu; then
        install_package libapache2-mod-shib2
        sudo a2enmod shib2
        sudo a2enmod ssl
    else
        exit_distro_not_supported "apache installation"
    fi
}


#
# exported functions
#

function install_keystone_federation {
    _install_mod_shib
}

function configure_keystone_federation {
    local here=$(cd $(dirname "$0") && pwd)
    local keystone_apache_conf=$(apache_site_config_for keystone)

    # insert our Apache federation snippet into the Apache config
    sudo sed -e "0,/<\/VirtualHost>/ {
        /<\/VirtualHost>/ {
            h
            r $FILES/apache-keystone-federation.template
            g
            N
        }
    }" -i $keystone_apache_conf

    # add the federation auth methods
    sudo sed -e "
        /^#methods/s/#\(.*\)$/\1,saml2/
        /^methods/a saml2 = keystone.auth.plugins.mapped.Mapped
    " -i $KEYSTONE_CONF

    # copy our mod_shib config file into place
    sudo cp $FILES/shibboleth2.xml /etc/shibboleth/

    # generate keys for mod_shib if they don't exist
    if [[ ! -e "/etc/shibboleth/sp-key.pem" ]]; then
        sudo shib-keygen -y 10
    fi
}

function init_keystone_federation {
    python $FILES/key-federation-setup.py
}

function start_keystone_federation {
    :
}

function stop_keystone_federation {
    :
}
